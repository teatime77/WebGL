<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>MNISTのディープラーニング</title>
    <script type="text/javascript" src="../js/util.js"></script>
    <script type="text/javascript" src="../js/gpgpu.js"></script>
    <script type="text/javascript" src="../js/shader.js"></script>
    <script type="text/javascript" src="../js/network.js"></script>
    <script type="text/javascript" src="../js/plot.js"></script>
    <script type="text/javascript" src="../js/MNIST.js"></script>
</head>
<body onload="BodyOnLoad()">
    <h3>MNISTのディープラーニング</h3>

以下のサイトから4つのファイルをダウンロード後に解凍して、このページにドロップしてください。<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;t10k-images.idx3-ubyte , t10k-labels.idx1-ubyte , train-images.idx3-ubyte , train-labels.idx1-ubyte<br />
<br />
<table border="1">
    <thead>
        <tr>
            <th ></th>
            <th >トレーニング</th>
            <th >テスト</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><b>コスト</b></td>
            <td>
                <canvas id="training-costs-canvas" width="300" height="200"></canvas><br />
                <b id="training-cost"></b>
            </td>
            <td>
                <canvas id="test-costs-canvas" width="300" height="200"></canvas><br />
                <b id="test-cost"></b>
            </td>
        </tr>
        <tr>
            <td><b>正解率</b></td>
            <td>
                <canvas id="training-accuracy-canvas" width="300" height="200"></canvas><br />
                <b id="training-accuracy"></b>
            </td>
            <td>
                <canvas id="test-accuracy-canvas" width="300" height="200"></canvas><br />
                <b id="test-accuracy"></b>
            </td>
        </tr>
    </tbody>
</table>
    
<br />
現在のエポック = <span id="epoch-idx"></span>&nbsp;&nbsp;&nbsp;&nbsp;処理済みデータ数 = <span id="processed-data-cnt"></span><br />
データ数 = ミニバッチの個数(<span id="mini-batch-cnt"></span>) × ミニバッチの大きさ(<span id="mini-batch-size"></span>) = <span id="total-data-cnt"></span><br />
ミニバッチごとの処理時間 ( 単位:ミリ秒 )<br />
&nbsp;&nbsp;&nbsp;&nbsp;全体 ( データ準備, 順伝播, コスト計算, 誤差逆伝播, パラメータ更新 )  <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="processed-time-all"></span><br />
&nbsp;&nbsp;&nbsp;&nbsp;レイヤー別 ( 順伝播, 誤差逆伝播, パラメータ更新 )  <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="processed-time-layer"></span><br />
<br />
    <input type="button" value="停止" id="stop-resume" onclick="StopResumeClick()" disabled="true"  />
<!-- 画像データの表示 ( デバック用 ) -->
<canvas id="digit-canvas" width="28" height="28" style="width:28px; height:28px; background-color:gainsboro"/>

<script type="text/javascript">

    var trainingCostsPlot, testCostsPlot, trainingAccuracyPlot, testAccuracyPlot;
    var theGPGPU;
    var NeuralNetworkTimer;
    var StopResumeButton;

    // 前回のプロット表示の時刻
    var lastPlotTime;

    // MNISTのデータ読み込みのヘルパー オブジェクト
    var mnist;

    /*
        ページロード時の初期処理
    */
    function BodyOnLoad() {
        trainingCostsPlot    = CreatePlot(document.getElementById('training-costs-canvas'));
        testCostsPlot        = CreatePlot(document.getElementById('test-costs-canvas'));
        trainingAccuracyPlot = CreatePlot(document.getElementById('training-accuracy-canvas'));
        testAccuracyPlot     = CreatePlot(document.getElementById('test-accuracy-canvas'));

        // 停止/再開ボタン
        StopResumeButton = document.getElementById('stop-resume');

        theGPGPU = CreateGPGPU();

        // MNISTのデータ読み込みのヘルパー オブジェクト
        mnist = new MNIST(document.getElementById('digit-canvas'));
    }

    /*
        停止/再開ボタン クリック
    */
    function StopResumeClick() {
        if (NeuralNetworkTimer) {
            // 実行中の場合

            clearInterval(NeuralNetworkTimer);
            NeuralNetworkTimer = undefined;

            theGPGPU.clearAll();

            StopResumeButton.value = "再開";
        }
        else {
            // 停止中の場合

            StopResumeButton.value = "停止";
            RunNeuralNetwork();
        }
    }

    function RunNeuralNetwork() {

        lastPlotTime = new Date();

        var net = CreateNeuralNetwork(theGPGPU);
        var learning_rate;          // 0.01;// 0.1;// 0.12;// 0.16;// 0.2;// 0.05;// 0.1;

        if (false) {

            net.setLayers([
                net.InputLayer(1, 28, 28),
                net.ConvolutionalLayer(5, 20, ActivationFunction.ReLU),
                net.MaxPoolingLayer(2),
                net.ConvolutionalLayer(5, 40, ActivationFunction.ReLU),
                net.MaxPoolingLayer(2),
                net.FullyConnectedLayer(100, ActivationFunction.ReLU),
                net.FullyConnectedLayer(10, ActivationFunction.none)
            ]);

            learning_rate = 0.1;
        }
        else {

            net.setLayers([
                net.InputLayer(1, 28, 28),
                net.ConvolutionalLayer(5, 20, ActivationFunction.ReLU),
                net.MaxPoolingLayer(2),
                net.ConvolutionalLayer(5, 40, ActivationFunction.ReLU),
                net.MaxPoolingLayer(2),
                net.FullyConnectedLayer(1000, ActivationFunction.ReLU),
                net.DropoutLayer(0.5),
                net.FullyConnectedLayer(1000, ActivationFunction.ReLU),
                net.DropoutLayer(0.5),
                net.FullyConnectedLayer(10, ActivationFunction.none)
            ]);

            learning_rate = 0.03;
        }

        var epochs = 60;
        var mini_batch_size = 10;

        var sgd_generator = net.SGD(mnist.trainingData, mnist.testData, epochs, mini_batch_size, learning_rate);

        NeuralNetworkTimer = setInterval(function () {
            var ret = sgd_generator.next().value;
            if (ret == 0) {

                clearInterval(NeuralNetworkTimer);
                NeuralNetworkTimer = undefined;

                theGPGPU.clearAll();
                console.log("学習が終わりました。");

                RunNeuralNetwork();
            }

            
            if (10 * 1000 < new Date() - lastPlotTime) {
                // 前回のプロット表示から10秒が経過した場合

                lastPlotTime = new Date();

                trainingCostsPlot.show(net.trainingCost, "red");
                testCostsPlot.show(net.testCost, "blue");
                trainingAccuracyPlot.show(net.trainingAccuracy, "blue");
                testAccuracyPlot.show(net.testAccuracy, "blue");

                showText("training-cost", net.trainingCost[net.trainingCost.length - 1].toFixed(3));
                showText("training-accuracy", net.trainingAccuracy[net.trainingAccuracy.length - 1].toFixed(3));

                if (net.testCost.length != 0) {

                    showText("test-cost", net.testCost[net.testCost.length - 1].toFixed(3));
                    showText("test-accuracy", net.testAccuracy[net.testAccuracy.length - 1].toFixed(3));
                }

                showText("processed-data-cnt", net.processedDataCnt);
                showText("epoch-idx", net.EpochIdx);

                showText("mini-batch-cnt", net.miniBatchCnt);
                showText("mini-batch-size", net.miniBatchSize);
                showText("total-data-cnt", net.miniBatchCnt * net.miniBatchSize);

                showText("processed-time-all", net.processedTimeAll);
                showText("processed-time-layer", net.processedTimeLayer);
            }
            
        }, 1)
    }

    /*
        テキストを表示する。
    */
    function showText(id, text) {
        document.getElementById(id).innerText = text;
    }

    /*
        DragOverのイベント処理
    */
    function DragOverHandler(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }


    /*
        Dropのイベント処理

        JavaScript で File API を使用してファイルを読み取る。
        https://www.html5rocks.com/ja/tutorials/file/dndfiles/
    */
    function DropHandler(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files; // FileList object.

        // files is a FileList of File objects. List some properties.
        for (var i = 0, f; f = files[i]; i++) {

            var reader = new FileReader();
                
            // Closure to capture the file information.
            reader.onload = (function (file_inf) {
                return function (e) {
                    // Render thumbnail.
                    var data = new Uint8Array(e.target.result);
                    var file_name = escape(file_inf.name);

                    mnist.onLoadFile(file_name, data);

                    if (mnist.trainingData && mnist.testData) {
                        // トレーニング データとテスト データを読み込んだ場合

                        StopResumeButton.disabled = false;
                        RunNeuralNetwork();
                    }
                };
            })(f);
                
            // Read in the image file as a data URL.
            reader.readAsArrayBuffer(f);
        }
    }

    // DragOverとDropのイベントを登録する。
    document.body.addEventListener('dragover', DragOverHandler, false);
    document.body.addEventListener('drop', DropHandler, false);
</script>
</body>
</html>